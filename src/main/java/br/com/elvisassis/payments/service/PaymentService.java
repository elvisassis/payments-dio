package br.com.elvisassis.payments.service;import br.com.elvisassis.payments.domain.Payment;import br.com.elvisassis.payments.domain.PaymentProviderResponse;import br.com.elvisassis.payments.domain.PaymentStatus;import br.com.elvisassis.payments.event.PaymentApprovedEvent;import br.com.elvisassis.payments.event.PaymentFailedEvent;import br.com.elvisassis.payments.provider.PaymentProvider;import br.com.elvisassis.payments.provider.PaymentProviderResolver;import br.com.elvisassis.payments.repository.PaymentRepository;import jakarta.transaction.Transactional;import org.springframework.context.ApplicationEventPublisher;import java.math.BigDecimal;public class PaymentService {    private final PaymentRepository paymentRepository;    private final PaymentProviderResolver providerResolver;    private final ApplicationEventPublisher eventPublisher;    public PaymentService(PaymentRepository paymentRepository, PaymentProviderResolver providerResolver, ApplicationEventPublisher eventPublisher) {        this.paymentRepository = paymentRepository;        this.providerResolver = providerResolver;        this.eventPublisher = eventPublisher;    }    @Transactional    public Payment process(BigDecimal amount, String providerName) {        // Criar pagamento        Payment payment = new Payment();        payment.setAmount(amount);        payment.setStatus(PaymentStatus.CREATED);        paymentRepository.save(payment);        // Resolver provider        PaymentProvider provider = providerResolver.resolve(providerName);        payment.markAsProcessing();        paymentRepository.save(payment);        //  Processar pagamento        PaymentProviderResponse response = provider.process(payment);        //  Atualizar estado        if (response.status() == PaymentStatus.APPROVED) {            payment.markAsApproved();            paymentRepository.save(payment);            eventPublisher.publishEvent(new PaymentApprovedEvent(payment.getId(), providerName));        } else {            payment.markAsFailed();            paymentRepository.save(payment);            eventPublisher.publishEvent(new PaymentFailedEvent(payment.getId(), providerName));        }        return paymentRepository.save(payment);    }}