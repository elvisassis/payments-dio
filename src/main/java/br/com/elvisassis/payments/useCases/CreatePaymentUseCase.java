package br.com.elvisassis.payments.service;import br.com.elvisassis.payments.domain.Payment;import br.com.elvisassis.payments.domain.PaymentProviderResponse;import br.com.elvisassis.payments.domain.PaymentStatus;import br.com.elvisassis.payments.dto.PaymentRequest;import br.com.elvisassis.payments.event.PaymentApprovedEvent;import br.com.elvisassis.payments.event.PaymentFailedEvent;import br.com.elvisassis.payments.provider.PaymentProvider;import br.com.elvisassis.payments.repository.PaymentRepository;import br.com.elvisassis.payments.resolver.PaymentProviderResolver;import jakarta.transaction.Transactional;import org.springframework.context.ApplicationEventPublisher;import org.springframework.stereotype.Service;@Servicepublic class UseCaseCreatePayment {    private final PaymentService paymentService;    private final PaymentRepository paymentRepository;    private final PaymentProviderResolver providerResolver;    private final ApplicationEventPublisher eventPublisher;    public UseCaseCreatePayment(PaymentService paymentService, PaymentRepository paymentRepository, PaymentProviderResolver providerResolver, ApplicationEventPublisher eventPublisher) {        this.paymentService = paymentService;        this.paymentRepository = paymentRepository;        this.providerResolver = providerResolver;        this.eventPublisher = eventPublisher;    }    @Transactional    public Payment process(PaymentRequest request) {        // Criar pagamento        Payment payment = Payment.create(                request.amount(),                request.currency(),                request.method(),                request.provider());        paymentRepository.save(payment);        // Resolver provider        PaymentProvider provider = providerResolver.resolve(request.provider());        payment.markAsProcessing();        paymentRepository.save(payment);        //  Processar pagamento        PaymentProviderResponse response = provider.process(payment);        //  Atualizar estado        if (response.status() == PaymentStatus.APPROVED) {            payment.markAsApproved(request.provider(), request.externalTransactionId());            paymentRepository.save(payment);            eventPublisher.publishEvent(new PaymentApprovedEvent(payment.getId(), request.provider()));        } else {            payment.markAsFailed();            paymentRepository.save(payment);            eventPublisher.publishEvent(new PaymentFailedEvent(payment.getId(), request.provider()));        }        return paymentRepository.save(payment);    }    public void execute(PaymentRequest paymentRequest) {        paymentService.process(paymentRequest);    }}